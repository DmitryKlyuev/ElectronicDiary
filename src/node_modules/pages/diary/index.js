import React, {Fragment, useEffect, useState} from "react";
import app from 'services/firebase/base';
import {Redirect} from "react-router-dom";
import {CurrentUserContext} from "contexts/currentUser";
import {useContext} from 'react';
import NoteForm from 'components/noteForm';
import 'pages/diary/style.css';


const Diary = () => {
    const initialValues = {text: ''};
    const [currentUserState, setCurrentUserState] = useContext(CurrentUserContext);
    const [count, setCount] = useState(0);
    const [data, setData] = useState([]);
    const res = [];


    // Отправка заполненной формы на сервер
    const handleSubmit = note => {
        if (!app.auth().currentUser) {
            signOut()
        } else {
            const db = app.database();
            const userId = app.auth().currentUser.uid;
            const ref = db.ref(userId);
            ref.push(note);
            setCount(count + 1)
        }
    };
    /////


    // Получение всех данных с сервера
    useEffect(() => {
        if (!app.auth().currentUser) {
            signOut()
        } else {
            const db = app.database();
            const userId = app.auth().currentUser.uid;
            const ref = db.ref(userId);
            ref.on("child_added", snapshot => {
                const data = snapshot.val();
                res.push(Object.values(data));
                setData(res);
            });
        }
    }, [count]);

    const pause = () => {
        return new Promise((res) => setTimeout(res, 100));
    };

    useEffect(() => {
        async function wait() {
            await pause();
            setCount(count + 1)
        }

        wait()
    }, []);
    /////

    // Удаление всех заметок
    const deletePost = () => {
        if (!app.auth().currentUser) {
            signOut()
        } else {
            const db = app.database();
            const userId = app.auth().currentUser.uid;
            const ref = db.ref(userId);
            ref.remove();
            ref.once("value", snapshot => {
                const data = snapshot.val();
                setData(data)
            });
        }
    };
    /////


    // Разлогин
    const signOut = () => {
        setCurrentUserState({isLoggedIn: false});
        app.auth().signOut();
    };

    if (currentUserState.isLoggedIn === false) {
        return <Redirect to='/'/>
    }
    /////

    return (
        <div className='container mt-lg-5 mb-5 p-5'>
            <div className='row'>
                <div className='col-lg-8'>
                    <div className='d-sm-flex justify-content-between mb-3'>
                        <h3 className='font-weight-bold'>Пиши заметку здесь</h3>
                        <button onClick={signOut} className='rounded common-button align-self-start'>Выйти</button>
                    </div>
                    <NoteForm onSubmit={handleSubmit} initialValues={initialValues}/>
                </div>
                <div className='col-lg-4'>
                    <div>
                        <ul className='list-group list-group-flush'>
                            {data && data.map(item => (
                                <Fragment>
                                    <h5 className='history-title'>История записей</h5>
                                    <button type="button" onClick={deletePost}
                                            className="clear-button">
                                        <span>Очистить</span>
                                    </button>
                                    <div className='list-group-item list-group-item-action rounded mb-3'>
                                        <li key={item} className='list-unstyled mb-2 mt-1'>
                                            {item[1]}
                                        </li>
                                        <small className='d-block text-right'>{item[0]}</small>
                                    </div>
                                </Fragment>
                            ))}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    )
};

export default Diary

